<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mail 10 phút – DropMail GraphQL (WebSocket) – HTML/CSS/JS</title>
  <style>
    :root{--bg:#ffffff;--panel:#f7faf7;--soft:#d9e7db;--text:#1b1f1c;--muted:#57635b;--accent:#31c36a;--accent-2:#22a455;--error:#e03131;--shadow:0 10px 30px rgba(0,0,0,.06);--radius:16px}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1000px;margin:0 auto;padding:18px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:6px 0 14px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;color:#fff;font-weight:700}
    h1{font-size:20px;margin:0}.muted{color:var(--muted);font-size:14px}
    .panel{background:var(--panel);border:1px solid var(--soft);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .grid{display:grid;gap:14px}.grid.cols{grid-template-columns:1.2fr .8fr}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:8px;background:#e9f7ef;color:#0f5132;border:1px solid #cfe8d9;padding:8px 10px;border-radius:12px;font-size:13px}
    .address{display:flex;gap:8px;align-items:center}
    input[type=text]{width:100%;padding:10px 12px;border:1px solid var(--soft);border-radius:12px;background:#fff}
    button{border:0;background:var(--accent);color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600;box-shadow:0 2px 0 rgba(0,0,0,.05)}
    button.ghost{background:#e8f7ee;color:#0f5132}button.warn{background:var(--error)}button:disabled{opacity:.6;cursor:not-allowed}
    .list{display:grid;gap:10px}
    .item{background:#fff;border:1px solid var(--soft);border-radius:14px;padding:10px;display:grid;gap:6px;cursor:pointer}
    .item:hover{outline:2px solid #d6f3e2}
    .item .top{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .item .from{font-weight:600}.item .subject{color:#0f5132}.item .intro{color:var(--muted);font-size:13px}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#eef8f2;border:1px solid #cfe8d9;color:#0f5132}
    .right{background:#fff;border:1px solid var(--soft);border-radius:14px;min-height:300px}
    .right header{padding:10px 12px;border-bottom:1px solid var(--soft)}
    .viewer{height:420px}iframe{width:100%;height:100%;border:0;border-radius:0 0 14px 14px}
    .empty{padding:18px;text-align:center;color:var(--muted)}
    .error{background:#fdecec;color:#8a2121;border:1px solid #f5b5b5;border-radius:12px;padding:10px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-size:12px;color:var(--muted)}
    @media (max-width:900px){.grid.cols{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">DM</div>
        <div>
          <h1>Mail 10 phút – Client dùng <span style="color:var(--accent-2)">DropMail GraphQL (WebSocket)</span></h1>
          <div class="muted">Tránh lỗi CORS bằng WebSocket; có fallback HTTP nếu WS lỗi.</div>
        </div>
      </div>
      <div class="row">
        <button id="btnNew">Tạo phiên mới</button>
        <button id="btnRefresh" class="ghost">Làm mới</button>
      </div>
    </header>

    <div class="panel grid cols">
      <div class="grid" style="align-content:start">
        <div class="panel" style="padding:12px">
          <div class="row" style="align-items:center;justify-content:space-between">
            <div class="address" style="flex:1">
              <span class="badge">Địa chỉ</span>
              <input type="text" id="address" readonly>
              <button id="btnCopy" class="ghost">Sao chép</button>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div style="flex:1">
              <input type="text" id="sessionId" placeholder="Session ID" readonly>
            </div>
            <div style="display:flex;gap:8px">
              <button id="btnAddAddr" class="ghost" title="Thêm địa chỉ vào cùng phiên">+ Địa chỉ</button>
              <button id="btnReset" class="warn" title="Xoá phiên & tạo lại">Reset</button>
            </div>
          </div>
          <div id="error" class="error" style="display:none;margin-top:10px"></div>
        </div>

        <div class="panel">
          <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:6px">
            <strong>Hộp thư đến</strong>
            <span class="muted" id="status">Đang kết nối…</span>
          </div>
          <div id="inbox" class="list"></div>
          <div id="emptyInbox" class="empty" style="display:none">Chưa có thư nào.</div>
        </div>
      </div>

      <div class="right">
        <header class="row" style="gap:8px">
          <div style="flex:1">
            <div id="viewSubject" style="font-weight:700">Chưa chọn thư</div>
            <div class="muted" id="viewMeta"></div>
          </div>
          <div style="display:flex;gap:8px">
            <a id="btnDownload" class="ghost" href="#" target="_blank" style="display:none;text-decoration:none;padding:10px 12px;border-radius:12px;border:1px solid #cfe8d9">Tải MIME</a>
          </div>
        </header>
        <div class="viewer">
          <iframe id="viewer" sandbox></iframe>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>API: <a href="https://dropmail.me/api/" target="_blank" rel="noreferrer">DropMail GraphQL</a></div>
      <div id="footerInfo">Endpoint WS: wss://dropmail.me/api/graphql/&lt;TOKEN&gt;/websocket</div>
    </div>
  </div>

  <script>
    const API_ROOT_HTTP = 'https://dropmail.me/api/graphql/';
    const API_ROOT_WS   = 'wss://dropmail.me/api/graphql/';

    const els = {
      address: document.getElementById('address'), sessionId: document.getElementById('sessionId'),
      btnNew: document.getElementById('btnNew'), btnRefresh: document.getElementById('btnRefresh'),
      btnCopy: document.getElementById('btnCopy'), btnAddAddr: document.getElementById('btnAddAddr'), btnReset: document.getElementById('btnReset'),
      inbox: document.getElementById('inbox'), emptyInbox: document.getElementById('emptyInbox'), status: document.getElementById('status'),
      error: document.getElementById('error'), viewer: document.getElementById('viewer'), viewSubject: document.getElementById('viewSubject'), viewMeta: document.getElementById('viewMeta'), btnDownload: document.getElementById('btnDownload'), footerInfo: document.getElementById('footerInfo')
    };

    let state = { token:null, sessionId:null, addresses:[], lastMailId:null, ws:null, wsReady:false, poller:null };

    function rand(n=12){ const chars='abcdefghijklmnopqrstuvwxyz0123456789'; let out=''; for(let i=0;i<n;i++) out+=chars[Math.floor(Math.random()*chars.length)]; return out; }
    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
    function showError(msg){ els.error.style.display='block'; els.error.textContent = msg; }
    function clearError(){ els.error.style.display='none'; els.error.textContent=''; }

    async function gqlHTTP(query, variables){
      const url = API_ROOT_HTTP + state.token;
      const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body: JSON.stringify({ query, variables }) });
      if(!res.ok){ const text = await res.text().catch(()=> ''); throw new Error(`HTTP ${res.status} ${res.statusText} – ${text.slice(0,200)}`); }
      const json = await res.json(); if(json.errors){ throw new Error(json.errors.map(e=>e.message).join('; ')); }
      return json.data;
    }

    function ensureWS(){
      return new Promise((resolve,reject)=>{
        if(state.ws && state.wsReady) return resolve();
        try{ state.ws = new WebSocket(API_ROOT_WS + state.token + '/websocket', 'graphql-transport-ws'); }
        catch(e){ return reject(e); }
        state.ws.addEventListener('open', ()=>{ state.ws.send(JSON.stringify({ type:'connection_init', payload:{} })); });
        state.ws.addEventListener('message', (ev)=>{ try{ const msg = JSON.parse(ev.data); if(msg.type==='connection_ack'){ state.wsReady=true; resolve(); } }catch{} });
        state.ws.addEventListener('error', err=>reject(err));
        state.ws.addEventListener('close', ()=>{ state.wsReady=false; state.ws=null; });
      });
    }

    function gqlWS(query, variables){
      return new Promise(async (resolve,reject)=>{
        try{ await ensureWS(); }catch(e){ return reject(e); }
        const id = String(Date.now()); let done=false;
        function onMessage(ev){ try{ const msg = JSON.parse(ev.data); if(msg.id!==id) return; if(msg.type==='next'){ resolve(msg.payload.data); } if(msg.type==='complete'){ done=true; state.ws.removeEventListener('message', onMessage); } if(msg.type==='error'){ reject(new Error(msg.payload?.message||'WS error')); } }catch(e){ reject(e); } }
        state.ws.addEventListener('message', onMessage);
        state.ws.send(JSON.stringify({ type:'subscribe', id, payload:{ query, variables } }));
        setTimeout(()=>{ if(!done){ state.ws.removeEventListener('message', onMessage); reject(new Error('WS timeout')); } }, 10000);
      });
    }

    async function gql(query, variables){
      try{ return await gqlWS(query, variables); }
      catch(e1){ console.warn('WS failed, fallback to HTTP:', e1); return await gqlHTTP(query, variables); }
    }

    async function introduceSession(){
      const q = `mutation New{ introduceSession { id, expiresAt, addresses { address } } }`;
      const data = await gql(q,{}); return data.introduceSession;
    }
    async function querySession(){
      const q = `query S($id:ID!){ session(id:$id){ id, expiresAt, addresses{ address }, mails{ id, rawSize, fromAddr, toAddr, downloadUrl, text, headerSubject, html } } }`;
      const d = await gql(q,{id: state.sessionId}); return d.session;
    }
    async function introduceAddress(){
      const q = `mutation Add($sid:ID!){ introduceAddress(input:{sessionId:$sid}){ address, restoreKey } }`;
      const d = await gql(q,{sid: state.sessionId}); return d.introduceAddress;
    }

    function renderInbox(mails){
      els.inbox.innerHTML=''; els.emptyInbox.style.display = mails.length? 'none' : 'block';
      mails.forEach((m)=>{ const div=document.createElement('div'); div.className='item'; const intro=(m.text||'').slice(0,120).replace(/\s+/g,' ').trim(); div.innerHTML=`<div class="top"><div class="from">${escapeHtml(m.fromAddr||'N/A')}</div><span class="pill">${(m.rawSize||0)} B</span></div><div class="subject">${escapeHtml(m.headerSubject||'(Không tiêu đề)')}</div><div class="intro">${escapeHtml(intro)}</div>`; div.addEventListener('click',()=>openMessage(m)); els.inbox.appendChild(div); });
    }
    function openMessage(m){
      els.viewSubject.textContent = m.headerSubject || '(Không tiêu đề)';
      els.viewMeta.textContent = `Từ: ${m.fromAddr||'N/A'} → ${m.toAddr||'N/A'} · Kích thước: ${m.rawSize||0}B`;
      const html = Array.isArray(m.html)? m.html.join('\n') : (m.html || null);
      const text = m.text || '(Không có nội dung)';
      const content = html || `<pre style="white-space:pre-wrap;font-family:ui-monospace,monospace">${escapeHtml(text)}</pre>`;
      els.viewer.srcdoc = content; els.btnDownload.style.display = m.downloadUrl? 'inline-flex' : 'none'; if(m.downloadUrl){ els.btnDownload.href = m.downloadUrl; }
    }
    function updateHeader(session){ els.sessionId.value = session.id; const addr=(session.addresses&&session.addresses[0]&&session.addresses[0].address)||state.addresses[0]||''; els.address.value=addr; els.status.textContent='Đã cập nhật: '+new Date().toLocaleTimeString(); }

    async function refresh(){ try{ const session = await querySession(); if(!session) throw new Error('Phiên đã hết hạn'); state.addresses = session.addresses.map(a=>a.address); renderInbox(session.mails||[]); updateHeader(session); }catch(err){ showError(err.message); } }
    function startPolling(){ stopPolling(); refresh(); state.poller = setInterval(refresh, 5000); }
    function stopPolling(){ if(state.poller){ clearInterval(state.poller); state.poller=null; } }

    function saveLocal(){ localStorage.setItem('dropmail', JSON.stringify({ token: state.token, sessionId: state.sessionId })); }
    function loadLocal(){ try{ const raw=localStorage.getItem('dropmail'); if(!raw) return false; const d=JSON.parse(raw); if(!d||!d.token||!d.sessionId) return false; state.token=d.token; state.sessionId=d.sessionId; return true; }catch{ return false; } }
    function clearLocal(){ localStorage.removeItem('dropmail'); }

    async function newSession(){
      clearError(); stopPolling(); state.token = rand(16);
      if(els.footerInfo) els.footerInfo.textContent = `Endpoint WS: wss://dropmail.me/api/graphql/${state.token}/websocket`;
      try{ const s = await introduceSession(); state.sessionId = s.id; saveLocal(); startPolling(); }
      catch(err){ showError('Tạo phiên lỗi: '+err.message); }
    }
    async function resetAll(){ if(!confirm('Xoá phiên hiện tại và tạo phiên mới?')) return; clearLocal(); await newSession(); }

    els.btnNew.onclick = newSession; els.btnRefresh.onclick = refresh;
    els.btnCopy.onclick = async () => { try{ await navigator.clipboard.writeText(els.address.value); els.btnCopy.textContent='Đã sao chép'; setTimeout(()=> els.btnCopy.textContent='Sao chép',1200);}catch{} };
    els.btnAddAddr.onclick = async () => { try{ const r = await introduceAddress(); alert('Đã thêm: '+r.address+'\nLưu restoreKey: '+r.restoreKey); refresh(); }catch(err){ showError(err.message); } };
    els.btnReset.onclick = resetAll;

    (async function init(){ clearError(); if(loadLocal()){ if(els.footerInfo) els.footerInfo.textContent = `Endpoint WS: wss://dropmail.me/api/graphql/${state.token}/websocket`; startPolling(); } else { await newSession(); } })();
  </script>
</body>
</html>
