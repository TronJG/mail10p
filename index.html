<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Tạm Thời - Cũ nhưng Nhanh</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    .mail-card { transition: all 0.2s; border-left: 3px solid transparent; }
    .mail-card:hover { border-left-color: #3b82f6; background-color: #f1f5f9; }
    .loader-bar { height: 2px; width: 100%; background: #e2e8f0; position: relative; overflow: hidden; }
    .loader-bar::after { content: ""; position: absolute; left: -50%; height: 100%; width: 50%; background: #3b82f6; animation: loading 1.2s infinite; }
    @keyframes loading { 0% { left: -50%; } 100% { left: 100%; } }
  </style>
</head>

<body class="p-4 md:p-8">
  <div class="max-w-xl mx-auto">
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6">
      <div class="p-5 border-b border-slate-100 flex justify-between items-center">
        <div class="flex items-center gap-2">
          <i data-lucide="mail" class="text-blue-600 w-5 h-5"></i>
          <h1 class="font-bold text-slate-800 uppercase tracking-tight text-sm">Hệ thống quét cũ</h1>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
          <span class="text-[10px] font-bold text-slate-400">LIVE SCAN</span>
        </div>
      </div>

      <div class="p-5">
        <div class="flex gap-2 mb-4">
          <input id="prefix" type="text" placeholder="Tên mail..."
            class="flex-grow px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-blue-500 text-sm">
          <select id="domains" class="bg-white border border-slate-200 rounded-lg px-2 text-xs font-semibold"></select>
        </div>

        <button id="btn-create"
          class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-sm hover:bg-blue-700 transition-all">
          TẠO EMAIL MỚI
        </button>
      </div>

      <div id="active-info" class="hidden p-4 bg-slate-50 border-t border-slate-100 flex justify-between items-center">
        <span id="current-email" class="font-mono text-sm font-bold text-slate-600"></span>
        <button id="btn-copy" class="text-blue-600 p-2 hover:bg-blue-100 rounded-lg" aria-label="Copy email">
          <i data-lucide="copy" class="w-4 h-4"></i>
        </button>
      </div>

      <div id="scan-bar" class="hidden loader-bar"></div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 min-h-[300px] overflow-hidden">
      <div id="inbox-list" class="divide-y divide-slate-100">
        <div class="p-16 text-center text-slate-400 text-sm italic">
          Đang đợi thư từ server apple.edu.pl...
        </div>
      </div>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-full max-w-lg max-h-[85vh] flex flex-col shadow-2xl">
      <div class="p-4 border-b flex justify-between items-center">
        <span id="modal-title" class="font-bold text-sm text-slate-600 truncate pr-4 uppercase"></span>
        <button id="btn-close" class="p-2 hover:bg-slate-100 rounded-full" aria-label="Close">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div id="modal-content" class="p-6 overflow-y-auto text-sm leading-relaxed text-slate-700"></div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const API = 'https://apple.edu.pl/api';
    const POLL_MS = 3000;

    // ===== DOM cache =====
    const $ = (id) => document.getElementById(id);
    const el = {
      prefix: $('prefix'),
      domains: $('domains'),
      btnCreate: $('btn-create'),
      btnCopy: $('btn-copy'),
      activeInfo: $('active-info'),
      currentEmail: $('current-email'),
      scanBar: $('scan-bar'),
      inboxList: $('inbox-list'),
      modal: $('modal'),
      modalTitle: $('modal-title'),
      modalContent: $('modal-content'),
      btnClose: $('btn-close'),
    };

    // ===== State =====
    const state = {
      token: localStorage.getItem('token') || '',
      email: localStorage.getItem('email') || '',
      timer: null,
      lastIdsKey: '', // giúp tránh render lại y chang
    };

    // ===== Helpers =====
    function setLoading(button, on) {
      button.disabled = on;
      button.innerHTML = on ? `<span class="animate-spin">●</span>` : `TẠO EMAIL MỚI`;
    }

    function showScanBar(show) {
      el.scanBar.classList.toggle('hidden', !show);
    }

    function openModal(title, html) {
      el.modalTitle.innerText = title || '';
      el.modalContent.innerHTML = html || '';
      el.modal.classList.replace('hidden', 'flex');
    }

    function closeModal() {
      el.modal.classList.replace('flex', 'hidden');
    }

    async function safeJson(res) {
      try { return await res.json(); } catch { return null; }
    }

    // Copy: KHÔNG thông báo (không alert, không toast)
    async function copyCurrentMail() {
      const text = (el.currentEmail.innerText || '').trim();
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
      } catch (_) {
        // Fallback cho browser chặn clipboard
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly', '');
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); } catch {}
        document.body.removeChild(ta);
      }
    }

    // ===== API calls =====
    async function loadDomains() {
      const res = await fetch(`${API}/domains`, { cache: 'no-store' });
      const data = await safeJson(res);
      const domains = data?.domains || [];
      el.domains.innerHTML = domains.map(i =>
        `<option value="${String(i.id)}">${String(i.domain)}</option>`
      ).join('');
    }

    async function createMail() {
      setLoading(el.btnCreate, true);

      const fd = new FormData();
      const prefix = el.prefix.value.trim();
      if (prefix) fd.append('prefix', prefix);
      fd.append('domain_id', el.domains.value);

      try {
        const res = await fetch(`${API}/create-session`, { method: 'POST', body: fd });
        const data = await safeJson(res);
        if (data?.status === 'success' && data?.token && data?.email) {
          state.token = data.token;
          state.email = data.email;
          localStorage.setItem('token', state.token);
          localStorage.setItem('email', state.email);
          startSession();
        } else {
          // giữ lại alert cho lỗi thực sự (tùy bạn bỏ)
          alert("Tạo mail thất bại!");
        }
      } catch (_) {
        alert("Lỗi API cũ!");
      } finally {
        setLoading(el.btnCreate, false);
      }
    }

    function startSession() {
      el.currentEmail.innerText = state.email || '';
      el.activeInfo.classList.toggle('hidden', !state.email);

      if (state.timer) clearInterval(state.timer);
      checkMail();
      state.timer = setInterval(checkMail, POLL_MS);
    }

    async function checkMail() {
      if (!state.token) return;

      showScanBar(true);
      try {
        const res = await fetch(`${API}/check-mail?token=${encodeURIComponent(state.token)}&_cache=${Date.now()}`, {
          cache: 'no-store'
        });
        const data = await safeJson(res);
        const msgs = data?.messages;
        if (Array.isArray(msgs)) renderInbox(msgs);
      } catch (_) {
        // im lặng như bản gốc
      } finally {
        setTimeout(() => showScanBar(false), 500);
      }
    }

    function renderInbox(msgs) {
      if (!msgs || msgs.length === 0) return;

      // Chống render lại nếu id list không đổi
      const idsKey = msgs.map(m => m?.id).join(',');
      if (idsKey && idsKey === state.lastIdsKey) return;
      state.lastIdsKey = idsKey;

      el.inboxList.innerHTML = msgs.map(m => {
        const sender = (m?.sender_name ?? '').toString();
        const subject = (m?.subject ?? '').toString();
        const receivedAt = (m?.received_at ?? '').toString();
        const time = receivedAt.includes(' ') ? receivedAt.split(' ')[1] : receivedAt;

        return `
          <button class="w-full text-left p-4 mail-card flex justify-between items-center"
                  data-id="${String(m.id)}" type="button">
            <div class="overflow-hidden">
              <p class="text-[10px] font-bold text-blue-500 uppercase">${escapeHtml(sender)}</p>
              <h4 class="text-sm font-semibold text-slate-700 truncate">${escapeHtml(subject)}</h4>
            </div>
            <span class="text-[10px] font-medium text-slate-400">${escapeHtml(time)}</span>
          </button>
        `;
      }).join('');
    }

    async function readMail(id) {
      if (!state.token) return;
      const res = await fetch(`${API}/read-mail?token=${encodeURIComponent(state.token)}&id=${encodeURIComponent(id)}&_t=${Date.now()}`, {
        cache: 'no-store'
      });
      const data = await safeJson(res);
      const msg = data?.message;
      if (!msg) return;

      const title = msg.subject || '';
      const html = msg.body_html
        ? msg.body_html
        : `<pre class="font-sans whitespace-pre-wrap">${escapeHtml(msg.body_text || '')}</pre>`;

      openModal(title, html);
    }

    // ===== Security helper (escape text fields) =====
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // ===== Events =====
    el.btnCreate.addEventListener('click', createMail);
    el.btnCopy.addEventListener('click', copyCurrentMail);
    el.btnClose.addEventListener('click', closeModal);

    // click outside modal to close
    el.modal.addEventListener('click', (e) => {
      if (e.target === el.modal) closeModal();
    });

    // event delegation for inbox
    el.inboxList.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-id]');
      if (!btn) return;
      readMail(btn.dataset.id);
    });

    // Quét ngay lập tức khi quay lại tab
    window.addEventListener('focus', () => { if (state.token) checkMail(); });

    // ===== Boot =====
    (async function init() {
      lucide.createIcons();
      await loadDomains();
      if (state.token && state.email) startSession();
    })();
  </script>
</body>
</html>
